# Story 2.1: Convex Schema Definition

## Status
Superseded - Split into 2.1a, 2.1b, 2.1c, 2.1d

## Story
**As a** Developer  
**I want to** define the comprehensive data schema in Convex  
**So that** we have a normalized, NDIS-compliant database with type-safe operations  

## Acceptance Criteria
1. Core entity tables defined (organizations, users, participants)
2. NDIS-specific tables created (plans, budgets, services)
3. Relationship tables implemented (addresses, emergency contacts, assignments)
4. Operational tables created (notes, incidents, leave requests)
5. Staff management tables created (availability, leave accruals)
6. Audit and compliance tracking implemented
7. All tables properly indexed for performance
8. Type-safe validation rules applied
9. Scheduled functions configured for automated processes

## Tasks / Subtasks

- [ ] Create schema file structure (AC: All)
  - [ ] Initialize convex/schema.ts with defineSchema import
  - [ ] Import convex validators (v)
  - [ ] Set up schema export structure
  - [ ] Plan table creation order for dependencies

- [ ] Implement core entity tables (AC: 1)
  - [ ] Create organizations table with subscription tracking
  - [ ] Create users table with Clerk integration and qualifications
  - [ ] Create participants table with NDIS fields and disability info
  - [ ] Add all required indexes for each table
  - [ ] Add validation rules for required fields

- [ ] Implement NDIS-specific tables (AC: 2)
  - [ ] Create ndisPlans table with plan management types
  - [ ] Create ndisBudgets table with support categories
  - [ ] Create services table for service delivery
  - [ ] Create claims table for NDIS billing
  - [ ] Add proper indexes for date-based queries

- [ ] Implement address management (AC: 3)
  - [ ] Create addresses table with entity linking
  - [ ] Support multiple address types (home, postal, service)
  - [ ] Add coordinates for service delivery
  - [ ] Create indexes by entity and organization
  - [ ] Add validation for Australian states and postcodes

- [ ] Implement emergency contacts (AC: 3)
  - [ ] Create emergencyContacts table
  - [ ] Add priority ordering system
  - [ ] Include decision-making authority flags
  - [ ] Support multiple contact types
  - [ ] Index by entity and priority

- [ ] Implement participant assignments (AC: 3)
  - [ ] Create participantAssignments junction table
  - [ ] Track role types (coordinator, worker, specialist)
  - [ ] Add period tracking with dates
  - [ ] Include availability preferences
  - [ ] Index by participant and user

- [ ] Implement notes system (AC: 4)
  - [ ] Create notes table with comprehensive types
  - [ ] Add visibility/access control levels
  - [ ] Support shift notes with specific fields
  - [ ] Link notes to entities (participants, services)
  - [ ] Index by entity, type, and importance

- [ ] Implement incident reporting (AC: 4)
  - [ ] Create incidents table with severity levels
  - [ ] Add investigation workflow fields
  - [ ] Include external reporting requirements (NDIS, WorkSafe)
  - [ ] Support witness statements and evidence
  - [ ] Add corrective actions tracking
  - [ ] Index by date, severity, and status

- [ ] Implement leave management (AC: 4, 5)
  - [ ] Create leaveRequests table with approval workflow
  - [ ] Create enhanced leaveBalances table with accrual rules
  - [ ] Create leaveAccruals table for transaction tracking
  - [ ] Add employment type and weekly hours for pro-rata
  - [ ] Configure accrual methods (monthly, fortnightly, anniversary)
  - [ ] Add coverage arrangement fields
  - [ ] Support multiple leave types with different rules
  - [ ] Include emergency leave handling
  - [ ] Index by user, dates, and status

- [ ] Implement staff availability system (AC: 5)
  - [ ] Create staffAvailability table with pattern types
  - [ ] Support recurring weekly patterns with time slots
  - [ ] Support fortnightly patterns (alternating weeks)
  - [ ] Support monthly patterns (specific days)
  - [ ] Add availability preferences (max hours, travel radius)
  - [ ] Create availabilityExceptions table for one-off changes
  - [ ] Add blackout dates for leave/training
  - [ ] Link exceptions to leave requests
  - [ ] Index by user, dates, and patterns

- [ ] Implement organizational features (AC: 4)
  - [ ] Create announcements table for message board
  - [ ] Add role-based targeting
  - [ ] Include read tracking
  - [ ] Support pinned messages
  - [ ] Index by organization and category

- [ ] Implement compliance tables (AC: 5)
  - [ ] Create documents table for compliance docs
  - [ ] Create auditLogs table for all changes
  - [ ] Add retention policy fields
  - [ ] Include versioning support
  - [ ] Index for compliance reporting

- [ ] Add cross-table validation (AC: 7)
  - [ ] Validate NDIS number format
  - [ ] Ensure date consistency across tables
  - [ ] Add phone number validation (Australian format)
  - [ ] Validate ABN format
  - [ ] Ensure monetary values are positive
  - [ ] Add email format validation

- [ ] Configure indexes for performance (AC: 7)
  - [ ] Add compound indexes for common queries
  - [ ] Create search indexes for full-text search
  - [ ] Add temporal indexes for date ranges
  - [ ] Optimize for real-time subscriptions
  - [ ] Document index strategy

- [ ] Set up scheduled functions (AC: 9)
  - [ ] Create cron configuration file
  - [ ] Set up daily leave accrual processing
  - [ ] Configure plan expiry checks
  - [ ] Add budget alert monitoring
  - [ ] Schedule incident report reminders
  - [ ] Document cron job timing strategy

- [ ] Test and verify schema (AC: All)
  - [ ] Run npx convex dev to compile schema
  - [ ] Verify all tables are created
  - [ ] Check TypeScript type generation
  - [ ] Test foreign key relationships
  - [ ] Validate against NDIS requirements
  - [ ] Document any deviations from design

## Dev Notes

### Previous Story Context
**Story 1.3 completed with:**
- TanStack Start project fully initialized
- Clerk authentication integrated and working
- UI foundation with Shadcn components
- Theme system and responsive layouts
- Development environment running successfully

### Refined Schema Design
**[Source: docs/architecture/refined-schema-proposal.md, leave-availability-enhancements.md]**

After extensive analysis and normalization, the schema has been redesigned to be fully NDIS-compliant with proper separation of concerns. The complete schema includes 21 interconnected tables:

#### Core Entity Tables
1. **organizations** - Organization management with subscription tracking
2. **users** - Staff with Clerk auth, qualifications, clearances (no manual employee ID needed)
3. **participants** - NDIS participants with disability info, cultural needs, communication requirements

#### NDIS-Specific Tables
4. **ndisPlans** - Plan periods, management types, goals, support coordination levels
5. **ndisBudgets** - Budget tracking by NDIS support categories (Core, Capacity Building, Capital)
6. **services** - Service delivery records with location tracking
7. **claims** - NDIS billing workflow

#### Relationship Tables
8. **addresses** - Normalized addresses for all entities (participants, services, organizations)
9. **emergencyContacts** - Priority-ordered contacts with decision-making authority
10. **participantAssignments** - Many-to-many worker-participant relationships with roles

#### Operational Tables
11. **notes** - Comprehensive note types (shift, coordination, medical) with access control
12. **incidents** - Full incident reporting with NDIS Quality & Safeguards compliance
13. **leaveRequests** - Staff leave management with approval workflow
14. **leaveBalances** - Enhanced with accrual rules, pro-rata calculations
15. **leaveAccruals** - Transaction history for all leave credits/debits
16. **announcements** - Organization-wide message board

#### Staff Management Tables
17. **staffAvailability** - Complex availability patterns (weekly, fortnightly, monthly)
18. **availabilityExceptions** - One-off changes to regular availability

#### Compliance Tables
19. **documents** - Compliance document management with versioning
20. **auditLogs** - Complete audit trail for all changes
21. **files** - Referenced via Convex _storage for attachments

### Key Design Decisions
**[Source: docs/architecture/refined-schema-proposal.md, leave-availability-enhancements.md]**

1. **Normalized Address Management**: Separate table allows multiple addresses per entity
2. **Emergency Contacts**: Standalone table with priority system and authority flags
3. **Worker Assignments**: Junction table for flexible many-to-many relationships
4. **Unified Notes System**: Single table with type field rather than multiple note tables
5. **Incident Reporting**: Comprehensive workflow for NDIS compliance
6. **Leave Management**: Automatic accruals with transaction tracking
7. **No Employee IDs**: Use email and Clerk ID instead of manual employee numbers
8. **Flexible Availability**: Support for complex patterns including fortnightly schedules
9. **Scheduled Functions**: Automated processes for leave accruals and alerts

### NDIS Compliance Features
- Proper support category tracking (Core, Capacity Building, Capital)
- Plan management types (Self, Plan, NDIA managed)
- Support coordination levels
- Mandatory incident reporting fields
- 7-year retention policy support
- Audit trail for all participant data access

### Technical Implementation Details
**[Source: docs/architecture/backend-architecture.md]**

- Use Convex validators (v) for all field definitions
- Implement indexes for common query patterns
- Use defineTable and defineSchema from convex/server
- All tables automatically get _id and _creationTime
- Leverage search indexes for full-text search
- Use v.id() for foreign key references

### File Locations
Based on Convex conventions:
- Main schema file: `convex/schema.ts`
- Type exports will be auto-generated in `convex/_generated/`
- No additional schema files needed - all in one file

### Validation Requirements
**[Source: docs/architecture/data-architecture.md]**

- NDIS numbers must be validated (format TBD by business rules)
- Dates stored as strings in ISO format
- Money amounts as numbers (cents to avoid floating point)
- Phone numbers optional but validated when present
- Email validation for user records

### Index Strategy
**[Source: docs/architecture/refined-schema-proposal.md]**

Comprehensive indexing for performance:
- **Entity lookups**: by_org, by_clerk, by_ndis
- **Temporal queries**: by_date, by_org_date, by_expiry
- **Status filtering**: by_status, by_org_status
- **Relationship queries**: by_participant, by_user, by_entity
- **Search indexes**: Full-text search on participants
- **Compliance queries**: by_severity, by_external reporting
- **Compound indexes**: For common multi-field queries

### Testing Requirements
- Schema must compile without errors
- All indexes must be created successfully
- TypeScript types must generate correctly
- Foreign key references must be valid
- Search indexes must be properly configured

### Dependencies
This story depends on:
- Epic 1 completion (all infrastructure ready) ✅
- Convex project initialized in Story 1.1 ✅

Next stories will depend on:
- Schema being defined for CRUD operations
- Type definitions for frontend usage
- Indexes for query performance

## Implementation Summary

This story implements a comprehensive, normalized database schema for an NDIS support coordination platform. The schema consists of 21 interconnected tables that handle:

- **Core Operations**: Participant management, staff management, service delivery
- **NDIS Compliance**: Plans, budgets, support categories, incident reporting
- **Relationships**: Addresses, emergency contacts, worker assignments
- **Workflow Systems**: Notes, leave requests with automatic accruals, announcements
- **Staff Management**: Complex availability patterns (weekly, fortnightly, monthly), leave tracking
- **Safety & Quality**: Incident reporting with NDIS Quality & Safeguards compliance
- **Audit & Compliance**: Complete audit trail and document management
- **Automation**: Scheduled functions for leave accruals and system alerts

Key improvements include:
- No manual employee IDs - uses email and Clerk auth
- Automatic leave accrual calculations with pro-rata support
- Flexible staff availability including fortnightly patterns
- Full transaction history for leave balances
- Scheduled cron jobs for automated processes

The schema is fully normalized to prevent data duplication, uses Convex's type-safe validators for data integrity, and includes comprehensive indexing for real-time performance. All NDIS-specific requirements are met including support categories, plan management types, and mandatory reporting fields.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-13 | 2.0 | Complete schema redesign with normalization | Bob (Scrum Master) |
| 2025-01-13 | 3.0 | Added leave accruals, staff availability, removed employee IDs | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

## QA Results
*This section will be populated by the QA team during review*