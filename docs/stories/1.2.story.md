# Story 1.2: Clerk Authentication Integration

## Status
Approved

## Story
**As a** User  
**I want** to sign in with secure authentication  
**So that** I can access my organization's data  

## Acceptance Criteria
1. Clerk authentication configured with Convex
2. Sign in/sign up flows working
3. User sync between Clerk and Convex
4. Protected routes implemented
5. Role-based access initialized

## Tasks / Subtasks

- [ ] Configure Clerk Provider in TanStack Start app (AC: 1)
  - [ ] Install Clerk React SDK: `npm install @clerk/clerk-react`
  - [ ] Add CLERK_PUBLISHABLE_KEY to .env.local
  - [ ] Wrap app with ClerkProvider in __root.tsx
  - [ ] Configure Clerk domain and settings

- [ ] Set up Convex authentication configuration (AC: 1)
  - [ ] Create convex/auth.config.ts with Clerk domain and applicationID
  - [ ] Configure JWT validation settings for Convex functions
  - [ ] Set up environment variables for Convex auth (CLERK_DOMAIN, CLERK_APP_ID)
  - [ ] Test authentication token validation

- [ ] Implement sign in/sign up flows (AC: 2)
  - [ ] Create routes/auth/sign-in.tsx using Clerk's SignIn component
  - [ ] Create routes/auth/sign-up.tsx using Clerk's SignUp component
  - [ ] Configure redirect URLs after authentication
  - [ ] Add sign out functionality
  - [ ] Test authentication flow end-to-end

- [ ] Create user sync webhook and Convex integration (AC: 3)
  - [ ] Set up Convex HTTP endpoint for Clerk webhooks
  - [ ] Create convex/users.ts with user management functions
  - [ ] Implement user creation/update on webhook events
  - [ ] Map Clerk user data to Convex users table schema
  - [ ] Handle organization assignment during user creation

- [ ] Implement route protection middleware (AC: 4)
  - [ ] Create auth helper functions in convex/auth.ts
  - [ ] Implement requireAuth helper for mutations/queries
  - [ ] Create useAuth hook for components
  - [ ] Add route guards to protected pages
  - [ ] Configure redirect behavior for unauthenticated users
  - [ ] Add error handling for authentication failures

- [ ] Initialize role-based access control system (AC: 5)
  - [ ] Define permission system structure in convex/lib/rbac.ts
  - [ ] Create requirePermission helper function
  - [ ] Set up default role assignments (admin, coordinator, support_worker, viewer)
  - [ ] Add role-based UI component rendering
  - [ ] Test permission enforcement across different roles

- [ ] Testing and validation
  - [ ] Test user registration flow creates Convex user record
  - [ ] Test sign in/out redirects work correctly
  - [ ] Test protected routes block unauthenticated access
  - [ ] Test webhook user sync for create/update/delete events
  - [ ] Verify JWT token validation in Convex functions

## Dev Notes

### Previous Story Context
**Story 1.1 completed successfully with:**
- TanStack Start project initialized with TypeScript
- Convex project created and connected
- Environment variables configured (CONVEX_URL in place)
- Placeholder for CLERK_PUBLISHABLE_KEY already added to .env.local

### Authentication Architecture Context
**[Source: docs/adr/003-clerk-authentication.md]**

Clerk has been selected as the authentication provider with the following benefits:
- Production-ready authentication out of the box
- Built-in MFA support and user management UI
- SOC 2 Type II compliant
- Native integration capabilities with Convex
- Handles password resets, email verification, and session management

**[Source: docs/architecture/technology-stack.md#authentication]**
- Clerk (primary provider) with social logins and MFA support
- Convex Auth integration for JWT validation
- Organizations support for multi-tenant architecture
- Webhook sync for user data consistency

### Convex Authentication Integration
**[Source: docs/architecture/backend-architecture.md#authentication-authorization]**

The authentication flow works as follows:
1. Clerk handles all user authentication UI and flows
2. Convex auth.config.ts validates JWT tokens from Clerk
3. User data synced to Convex via webhooks for database operations
4. Role-based access control enforced at the function level

Required configuration:
```typescript
// convex/auth.config.ts
export default {
  providers: [
    {
      domain: process.env.CLERK_DOMAIN,
      applicationID: process.env.CLERK_APP_ID,
    },
  ],
};
```

### User Schema and Role System
**[Source: docs/architecture/backend-architecture.md#database-schema-design]**

Users table structure:
```typescript
users: defineTable({
  clerkId: v.string(), // External auth ID
  organizationId: v.id("organizations"),
  profile: v.object({
    firstName: v.string(),
    lastName: v.string(),
    email: v.string(),
    phone: v.optional(v.string()),
    avatar: v.optional(v.id("_storage")),
  }),
  role: v.union(
    v.literal("admin"),
    v.literal("coordinator"),
    v.literal("support_worker"),
    v.literal("finance"),
    v.literal("viewer")
  ),
  permissions: v.array(v.string()), // Granular permissions
  status: v.union(v.literal("active"), v.literal("inactive"), v.literal("suspended")),
  // ... other fields
})
  .index("by_clerk", ["clerkId"])
  .index("by_org", ["organizationId"])
```

### Role-Based Access Control Implementation
**[Source: docs/architecture/security-architecture.md]**

Permission structure by role:
- `admin`: All permissions (*)
- `coordinator`: participant:*, service:*, budget:read, message:read
- `support_worker`: participant:read:assigned, service:create:own, service:read:own
- `finance`: participant:read, service:*, claim:*, budget:read
- `viewer`: participant:read, service:read, budget:read

Helper functions to implement:
```typescript
// requireAuth - validates JWT and returns user
// requirePermission - checks role-based permissions
// checkPermission - utility for UI conditional rendering
```

### Frontend Integration Points
**[Source: docs/architecture/frontend-architecture.md]**

Key integration points:
1. Root layout (__root.tsx) - ClerkProvider wrapper
2. Authentication routes (routes/auth/) - Sign in/up components
3. Route guards for protected pages
4. useAuth hook for accessing user state
5. Conditional rendering based on user roles

### File Locations and Structure
**[Source: docs/architecture/frontend-architecture.md#project-structure]**

Files to create/modify:
```
src/
├── routes/
│   ├── __root.tsx          # Add ClerkProvider
│   ├── auth/
│   │   ├── sign-in.tsx     # Clerk SignIn component
│   │   └── sign-up.tsx     # Clerk SignUp component
├── lib/
│   └── hooks/
│       └── use-auth.ts     # Auth hook
convex/
├── auth.config.ts          # Clerk configuration
├── auth.ts                 # Auth helper functions
├── users.ts                # User management functions
└── lib/
    └── rbac.ts             # Role-based access control
```

### Environment Variables Required
**[Source: docs/architecture/backend-architecture.md#environment-configuration]**

Add to .env.local:
- `CLERK_PUBLISHABLE_KEY` - Frontend Clerk key (already placeholder exists)
- `CLERK_SECRET_KEY` - Backend Clerk key (for webhooks)
- `CLERK_DOMAIN` - Convex auth config
- `CLERK_APP_ID` - Convex auth config

### Webhook Configuration
**[Source: docs/architecture/backend-architecture.md#authentication-authorization]**

Webhook endpoint implementation needed:
1. HTTP endpoint in Convex to receive Clerk webhooks
2. User sync logic for create/update/delete events
3. Organization assignment logic during user creation
4. Error handling and retry mechanisms
5. **Security Note**: Validate webhook signatures using Clerk's webhook secret

### Security Considerations
**[Source: docs/architecture/security-architecture.md]**

Security measures to implement:
- JWT validation at function level
- Row-level security via organization isolation  
- Input validation on all user data
- Rate limiting on auth endpoints
- Secure webhook verification

### Testing Requirements
**[Source: docs/architecture/backend-architecture.md#testing-strategy]**

Testing approach:
- Unit tests for auth helper functions using Convex test client
- Integration tests for user sync webhook functionality
- E2E tests for complete sign in/up flows
- Role-based access control verification tests

No specific test file locations defined in architecture - follow Vitest conventions in __tests__ directories alongside components.

**Development Testing Note**: Use Clerk's test mode for development to avoid consuming production authentication attempts. Test keys will be provided in the Clerk dashboard.

### Integration Dependencies
This story depends on:
- Story 1.1 completion (TanStack Start + Convex setup) ✅
- Convex deployment URL available in .env.local ✅
- Project structure from Story 1.1 in place ✅

Next story (1.3) will depend on:
- Authentication working and user context available
- Route protection implemented
- User roles defined and accessible

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-13 | 1.1 | Approved by PO with security enhancements | Sarah (Product Owner) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent after implementation*